<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebSocket Chat</title>
</head>
<body>
	<script type="text/javascript">
		//socket1:
		var socket1;
		var retry1=1;
		var transfer1=1;
		var websocketurl1="ws://218.94.149.27:33891/ws";
		if (!window.WebSocket) {
			window.WebSocket = window.MozWebSocket;
		}
		if (window.WebSocket) {
			init1();
		} else {
			alert("你的浏览器不支持 WebSocket！");
		}
		
		//socket2:
		var socket2;
		var retry2=1;
		var transfer2=1;
		var websocketurl2="ws://localhost:33891/ws";
		if (!window.WebSocket) {
			window.WebSocket = window.MozWebSocket;
		}
		if (window.WebSocket) {
			init2();
		} else {
			alert("你的浏览器不支持 WebSocket！");
		}

		function init1(){
			open1();
			socket1.onopen = function(event) {
				var ta = document.getElementById('responseText1');
				ta.value = "连接开启!";
				retry1=1;
				transfer1=1;
				sendAuth();
			};
			socket1.onclose = function(event) {
				var ta = document.getElementById('responseText1');
				ta.value ="第"+retry1+"次尝试:"+"连接被关闭,1秒后重试!";
				retry1=retry1+1;
				setTimeout('init1()',1000);
			};
			socket1.onmessage = function(event) {
				var ta = document.getElementById('responseText1');
				if(event.data instanceof ArrayBuffer){
					if (!window.WebSocket) {
						return;
					}
					if (socket2.readyState == WebSocket.OPEN) {
						//ta.value ="第"+transfer1+"次:"+"消息转发!";
						transfer1=transfer1+1;
						socket2.send(event.data);
					} else {
						alert("连接没有开启.");
					} 
				}else{
					ta.value = ta.value + '\n' + event.data;
				}
			};
		}
		
		function send1(message) {
			if (!window.WebSocket) {
				return;
			}
			if (socket1.readyState == WebSocket.OPEN) {
				socket1.send(message);
			} else {
				alert("连接没有开启.");
			}
		}
		
		function open1(){
			socket1 = new WebSocket(websocketurl1);
			socket1.binaryType = 'arraybuffer'; // 指定WebSocket接受ArrayBuffer实例作为参数
		}

		function init2(){
			open2();
			socket2.onopen = function(event) {
				var ta = document.getElementById('responseText2');
				ta.value = "连接开启!";
				retry2=1;
				transfer2=1;
				sendAuth();
			};
			socket2.onclose = function(event) {
				var ta = document.getElementById('responseText2');
				ta.value ="第"+retry2+"次尝试:"+"连接被关闭,1秒后重试";
				retry2=retry2+1;
				setTimeout('init2()',1000);
			};
			socket2.onmessage = function(event) {
				var ta = document.getElementById('responseText2');
				if(event.data instanceof ArrayBuffer){
					if (!window.WebSocket) {
						return;
					}
					if (socket1.readyState == WebSocket.OPEN) {
						//ta.value = "第"+transfer2+"次:"+"消息转发!";
						transfer2=transfer2+1;
						socket1.send(event.data);
					} else {
						alert("连接没有开启.");
					} 
				}else{
					ta.value = ta.value + '\n' + event.data;
				}
			};
		}
		
		function send2(message) {
			if (!window.WebSocket) {
				return;
			}
			if (socket2.readyState == WebSocket.OPEN) {
				socket2.send(message);
			} else {
				alert("连接没有开启.");
			}
		}
		
		function open2(){
			socket2 = new WebSocket(websocketurl2);
			socket2.binaryType = 'arraybuffer'; // 指定WebSocket接受ArrayBuffer实例作为参数
		}
		
		function sendAuth(){
			if (socket1.readyState == WebSocket.OPEN && socket2.readyState == WebSocket.OPEN) {
				socket2.send("auth");
			}else{
				setTimeout('sendAuth()',1000);
			}
		}
		
		//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
		window.onbeforeunload = function() {
			closeWebSocket();
		}
		//关闭WebSocket连接
		function closeWebSocket() {
			socket1.close();
			socket2.close();
		}
		
	</script>
	<form onsubmit="return false;">
		<h3>WebSocket1：</h3>
		<textarea id="responseText1" style="width: 500px; height: 300px;"></textarea>
		<br> <input type="text" name="message" style="width: 300px"
			value="Welcome to www.waylau.com"> <input type="button"
			value="发送消息" onclick="send1(this.form.message.value)">
		<button onclick="closeWebSocket()">关闭WebSocket连接</button>
	</form>
	<form onsubmit="return false;">
		<h3>WebSocket2：</h3>
		<textarea id="responseText2" style="width: 500px; height: 300px;"></textarea>
		<br> <input type="text" name="message" style="width: 300px"
			value="Welcome to www.waylau.com"> <input type="button"
			value="发送消息" onclick="send2(this.form.message.value)">
		<button onclick="closeWebSocket()">关闭WebSocket连接</button>
	</form>
	<br>
	<br>
</body>
</html>